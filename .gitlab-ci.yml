image: gcc

default:
  before_script:
    - |
      if [ "$CI_SERVER_HOST" = "gitlab.com" ]; then
        echo "deb http://http.us.debian.org/debian stable main contrib non-free" >> /etc/apt/sources.list
      fi
    - apt-get update -y
    - apt-get install -y gcc-13 g++-13 gfortran-13 dpkg-dev
    - update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 60 --slave /usr/bin/g++ g++ /usr/bin/g++-13
    - update-alternatives --install /usr/bin/gfortran gfortran /usr/bin/gfortran-13 60
    - apt-get install -y openmpi-bin libopenmpi-dev libblas-dev liblapack-dev libscalapack-mpi-dev cmake

stages:
  - build
  - test

# =========================================================
# 1. DEFINE PLATFORM CONFIGS ONCE (The "Mixins")
# =========================================================

# Configuration for GitLab.com
.env_com:
  tags: [butterflypack-tr4workstation]
  rules:
    - if: '$CI_SERVER_HOST == "gitlab.com"'

# Configuration for Spack.io
.env_spack:
  tags: [hpsf-gpu, x86_64-nvidiagpu, nvidia-a100]
  rules:
    - if: '$CI_SERVER_HOST == "gitlab.spack.io"'

# =========================================================
# 2. DEFINE SHARED LOGIC (Scripts)
# =========================================================

.build_script:
  stage: build
  script:
    - MULTIARCH=$(dpkg-architecture -qDEB_HOST_MULTIARCH)
    - echo "MULTIARCH = $MULTIARCH"
    - export BLAS_LIB=/usr/lib/$MULTIARCH/libblas.so
    - export LAPACK_LIB=/usr/lib/$MULTIARCH/liblapack.so
    - export SCALAPACK_LIB="/usr/lib/$MULTIARCH/libscalapack-openmpi.so"
    - echo "YL; Installing ButterflyPACK from source"
    - rm -rf build && mkdir -p build && cd build
    - cmake .. -DBUILD_SHARED_LIBS=OFF -DCMAKE_C_COMPILER=mpicc -DCMAKE_CXX_COMPILER=mpic++ -DCMAKE_Fortran_COMPILER=mpif90 -DCMAKE_INSTALL_PREFIX=. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE:BOOL=OFF -DTPL_BLAS_LIBRARIES="$BLAS_LIB" -DTPL_LAPACK_LIBRARIES="$LAPACK_LIB" -DTPL_SCALAPACK_LIBRARIES="$SCALAPACK_LIB"
    - make -j$(nproc)
    - make install
    - cd ..
  artifacts:
    paths: [build]
    expire_in: 1 week

.test_script:
  stage: test
  script:
    - echo "Running test number ${TEST_NUMBER}"
    - sh .ci_tests.sh

# =========================================================
# 3. CONCRETE BUILD JOBS
# =========================================================

# Merges (.build_script + .env_com)
build-com:
  extends: [.build_script, .env_com]

# Merges (.build_script + .env_spack)
build-spack:
  extends: [.build_script, .env_spack]

# =========================================================
# 4. TEST TEMPLATES (Linking Build to Test)
# =========================================================

# Inherits config from .env_com and waits for build-com
.test_com:
  extends: [.test_script, .env_com]
  needs: ["build-com"]

# Inherits config from .env_spack and waits for build-spack
.test_spack:
  extends: [.test_script, .env_spack]
  needs: ["build-spack"]

# =========================================================
# 5. TEST DEFINITIONS
# =========================================================

# Test 1 runs on BOTH platforms
test_1/16:
  extends: .test_com
  variables: { TEST_NUMBER: "1" }

test_1/16-spack:
  extends: .test_spack
  variables: { TEST_NUMBER: "1" }

# Tests 2-16 run ONLY on GitLab.com (inheriting .test_com)
test_2/16:
  extends: .test_com
  variables: { TEST_NUMBER: "2" }

test_3/16:
  extends: .test_com
  variables: { TEST_NUMBER: "3" }

test_4/16:
  extends: .test_com
  variables: { TEST_NUMBER: "4" }

test_5/16:
  extends: .test_com
  variables: { TEST_NUMBER: "5" }

test_6/16:
  extends: .test_com
  variables: { TEST_NUMBER: "6" }

test_7/16:
  extends: .test_com
  variables: { TEST_NUMBER: "7" }

test_8/16:
  extends: .test_com
  variables: { TEST_NUMBER: "8" }

test_9/16:
  extends: .test_com
  variables: { TEST_NUMBER: "9" }

test_10/16:
  extends: .test_com
  variables: { TEST_NUMBER: "10" }

test_11/16:
  extends: .test_com
  variables: { TEST_NUMBER: "11" }

test_12/16:
  extends: .test_com
  variables: { TEST_NUMBER: "12" }

test_13/16:
  extends: .test_com
  variables: { TEST_NUMBER: "13" }

test_14/16:
  extends: .test_com
  variables: { TEST_NUMBER: "14" }

test_15/16:
  extends: .test_com
  variables: { TEST_NUMBER: "15" }

test_16/16:
  extends: .test_com
  variables: { TEST_NUMBER: "16" }